<script>
    const chatBox = document.querySelector('.chat-box');
    let userMessages = [];
    let assistantMessages = [];
    let myDateTime = '';
    let userId = ''; // userId ë³€ìˆ˜ ì¶”ê°€

    // --- ì¶”ê°€ëœ ë¶€ë¶„: ì‚¬ìš©ì ID ê´€ë¦¬ ---
    function getOrCreateUserId() {
        let storedUserId = localStorage.getItem('chatbotUserId');
        if (!storedUserId) {
            // ìµœì‹  ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›í•˜ëŠ” ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ UUID ìƒì„±
            storedUserId = crypto.randomUUID(); 
            localStorage.setItem('chatbotUserId', storedUserId);
        }
        return storedUserId;
    }
    // ------------------------------------

    function start() {
        const date = document.getElementById('date').value;
        const hour = document.getElementById('hour').value;
        if (date === '') {
            alert('ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        myDateTime = date + " " + hour + "ì‹œ"; // ì‹œê°„ ë‹¨ìœ„ë¥¼ ëª…í™•í•˜ê²Œ ì¶”ê°€

        // í˜ì´ì§€ê°€ ì‹œì‘ë  ë•Œ userIdë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±í•©ë‹ˆë‹¤.
        userId = getOrCreateUserId(); 

        document.getElementById("intro").style.display = "none";
        document.getElementById("chat").style.display = "block";
    }

    async function sendMessage() {
        const chatInput = document.querySelector('.chat-input input');
        if (chatInput.value.trim() === "") return; // ë¹ˆ ë©”ì‹œì§€ ì „ì†¡ ë°©ì§€

        const userMessageText = chatInput.value;
        const chatMessage = document.createElement('div');
        chatMessage.classList.add('chat-message');
        chatMessage.innerHTML = `<p>${userMessageText}</p>`;
        chatBox.appendChild(chatMessage);
        
        // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ì•„ë˜ë¡œ ì´ë™
        chatBox.scrollTop = chatBox.scrollHeight;

        userMessages.push(userMessageText);
        chatInput.value = '';
        document.getElementById('loader').style.display = "block";

        try {
            // ğŸš¨ ì¤‘ìš”: ì´ URLì€ ì•„ë˜ IaC ë°°í¬ í›„ ìƒì„±ëœ ì‹¤ì œ ì£¼ì†Œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
            const response = await fetch('YOUR_API_GATEWAY_URL/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: userId, // â­ï¸ ìˆ˜ì •: userIdë¥¼ ìš”ì²­ì— í¬í•¨
                    myDateTime: myDateTime,
                    userMessages: userMessages,
                    assistantMessages: assistantMessages
                })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            assistantMessages.push(data.assistant);

            const astrologerMessage = document.createElement('div');
            astrologerMessage.classList.add('chat-message');
            astrologerMessage.innerHTML = `<p class='assistant'>${data.assistant}</p>`;
            chatBox.appendChild(astrologerMessage);

        } catch (error) {
            console.error('Error sending message:', error);
            const errorMessage = document.createElement('div');
            errorMessage.classList.add('chat-message');
            errorMessage.innerHTML = `<p class='assistant' style='color: red;'>ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>`;
            chatBox.appendChild(errorMessage);
        } finally {
            document.getElementById('loader').style.display = "none";
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }
</script>